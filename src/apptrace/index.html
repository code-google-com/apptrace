<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C //DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Apptrace - {{ app_id }}</title>
    <script type="text/javascript" src="/_ah/apptrace/static/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="/_ah/apptrace/static/flot/jquery.flot.min.js"></script>
    <!--[if IE]><script language="javascript" type="text/javascript" src="/_ah/apptrace/static/flot/excanvas.pack.js"></script><![endif]-->
    <link rel="stylesheet" href="/_ah/apptrace/static/apptrace.css"
      type="text/css" media="all" />
  </head>
  <body>
    <h1>Apptrace - {{ app_id }}</h1>
    <div id="chart" style="width:800px;height:200px"></div>
    <div id="legend"></div>
    <div id="actions">
      <input id="refresh" type="button" value="Refresh" />
      <a href="{{ records_url }}">Download raw data</a>
    </div>

    <script type="text/javascript">
      $(function () {
        var options = {
          lines: { show: true },
          points: { show: true },
          xaxis: { tickDecimals: 0, tickSize: 1 },
          legend: { container: $('#legend'), noColumns: 10 }
        };

        var chart = $("#chart");
        var series = {};
        var chart_data = [];

        $.plot(chart, chart_data, options);

        function updateData(data) {
          var records = JSON.parse(data);
          series = {};
          chart_data = [];

          for (i=0; i<records.length; i++) {
            var record = records[i];
            for (j=0; j<record.entries.length; j++) {
              var entry = record.entries[j];
              if (!series[entry.name])
                series[entry.name] = {label: entry.name, data: []};
              series[entry.name].data.push([record.index,
                                            entry.dominated_size]);
            }
          }
          for (var key in series)
            chart_data.push(series[key]);
          $.plot(chart, chart_data, options);
        }

        $('#refresh').click(function() {
          var button = $(this);
          var url = button.siblings('a').attr('href');
          $.ajax({
            url: url,
            method: 'GET',
            success: updateData
          });
        });

        $('#refresh').click();
      });
    </script>
  </body>
</html>
